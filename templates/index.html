<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SenaAI - Asistente Virtual De Instructores</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/logo-sena-verde-complementario-png-2022.png">
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" href="/static/css/chatbot.css"> <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,800,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="homePage" class="page">
        <header class="header">
            <h1>Gesti√≥n Acad√©mica y Disciplinaria - SENA</h1>
            <p>Sistema de apoyo para instructores</p>
        </header>

        <main class="main">
            <div class="intro">
                <h2>¬øQu√© situaci√≥n necesitas gestionar?</h2>
                <p>Selecciona el tipo de situaci√≥n para recibir una gu√≠a paso a paso</p>
            </div>

            <div class="card-grid">
    <div class="card">
        <div class="icon-circle blue"><span>üìò</span></div>
        <h3>Situaci√≥n Acad√©mica</h3>
        <p>
            Gestiona situaciones relacionadas con el rendimiento acad√©mico, 
            entregas de evidencias y seguimiento del proceso formativo.
        </p>
        <button id="openAcademicoModalButton" class="btn" onclick="abrirModalAcademico()">Ir a Gesti√≥n Acad√©mica</button>
    </div>

    <div class="card">
        <div class="icon-circle red"><span style="font-size:2.2rem;line-height:1;">‚ö†Ô∏è</span></div>
        <h3>Situaci√≥n Disciplinaria</h3>
        <p>
            Maneja situaciones comportamentales y disciplinarias siguiendo 
            los protocolos establecidos por la instituci√≥n.
        </p>
        <button id="openDisciplinarioModalButton" class="btn" onclick="abrirModalDisciplinario()">Ir a Gesti√≥n Disciplinaria</button>
    </div>
</div>
        </main>
    </div>

    <div class="protocolos-box">
        <h3>Protocolos y las medidas formativas</h3>
        <p>Descarga todos los documentos y protocolos necesarios para la gesti√≥n acad√©mica y disciplinaria</p>
        <a href="{{ url_for('descargar') }}"> <button class="btn download-btn">
                <span style="margin-right:8px;">&#128229;</span> Descargar
            </button>
        </a>
    </div>

    <div id="modalDisciplinario" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="cerrarModalDisciplinario()">&times;</span>
            <div id="modalTemas">
                <h3>Selecciona una situaci√≥n disciplinaria:</h3>
                <div class="temas-grid">
                    <div class="tema-opcion">
                        <span class="tema-icono">üìÜ</span>
                        <h4>Asistencia</h4>
                        <button class="tema-btn" onclick="seleccionarTema('inasistencias')">Inasistencias y Retiro Injustificado</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üìù</span>
                        <h4>Fraude/Plagio</h4>
                        <button class="tema-btn" onclick="seleccionarTema('fraude_plagio')">Incumplimiento Acad√©mico y Fraude</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">ü§ù</span>
                        <h4>Convivencia</h4>
                        <button class="tema-btn" onclick="seleccionarTema('convivencia')">Convivencia y Respeto</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üè¢</span>
                        <h4>Recursos</h4>
                        <button class="tema-btn" onclick="seleccionarTema('recursos')">Uso Indebido de Recursos</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">ü¶∫</span>
                        <h4>Seguridad</h4>
                        <button class="tema-btn" onclick="seleccionarTema('seguridad')">Normas de Seguridad</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üèõÔ∏è</span>
                        <h4>Imagen</h4>
                        <button class="tema-btn" onclick="seleccionarTema('imagen')">Imagen Institucional</button>
                    </div>
                    <div class="tema-opcion centrar-ultimo">
                        <span class="tema-icono">üìã</span>
                        <h4>Generales</h4>
                        <button class="tema-btn" onclick="seleccionarTema('generales')">Deberes Generales</button>
                    </div>
                </div>
            </div>
            <div id="modalPreguntas" style="display:none;">
                <p id="modalPregunta"></p>
                <div class="modal-buttons" id="modalBotones"></div>
                <button class="btn" style="margin-top:2rem;" onclick="volverTemas()">‚Üê Volver a Temas</button>
            </div>
            <div class="final-accion" id="finalAccionDisciplinario" style="display:none;">
                <p id="mensajeFinalDisciplinario"></p>
                <button class="btn download" onclick="descargarFormatoDisciplinario()">‚¨áÔ∏è Descargar Guia</button>
                <button class="btn" style="margin-top:1.2rem;" onclick="volverTemas()">Consultar otro caso</button>
            </div>
        </div>
    </div>

    <div id="modalAcademico" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-button" onclick="cerrarModalAcademico()">&times;</span>
            <div id="modalTemasAcademico">
                <h3>Selecciona una situaci√≥n acad√©mica:</h3>
                <div class="temas-grid">
                    <div class="tema-opcion">
                        <span class="tema-icono">üéØ</span>
                        <h4>Dificultades en Resultados de Aprendizaje</h4>
                        <button class="tema-btn" onclick="seleccionarTemaAcademico('resultados')">Dificultades en el Logro de Resultados</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üìÑ</span>
                        <h4>Evidencias de Aprendizaje</h4>
                        <button class="tema-btn" onclick="seleccionarTemaAcademico('evidencias')">Incumplimiento en la Entrega de Evidencias</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üôã‚Äç‚ôÇÔ∏è</span>
                        <h4>Participaci√≥n y Compromiso</h4>
                        <button class="tema-btn" onclick="seleccionarTemaAcademico('participacion')">Baja Participaci√≥n y Compromiso</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üìù</span>
                        <h4>Planes de Mejoramiento</h4>
                        <button class="tema-btn" onclick="seleccionarTemaAcademico('mejoramiento')">Necesidad y Cumplimiento de Planes</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üß©</span>
                        <h4>Prerrequisitos y Avance</h4>
                        <button class="tema-btn" onclick="seleccionarTemaAcademico('prerrequisitos')">Prerrequisitos y Ruta de Aprendizaje</button>
                    </div>
                    <div class="tema-opcion">
                        <span class="tema-icono">üíª</span>
                        <h4>Recursos Tecnol√≥gicos</h4>
                        <button class="tema-btn" onclick="seleccionarTemaAcademico('tecnologia')">Uso de Recursos Tecnol√≥gicos</button>
                    </div>
                    <div class="tema-opcion centrar-ultimo">
                        <span class="tema-icono">ü§ù</span>
                        <h4>Acuerdos Acad√©micos</h4>
                        <button class="tema-btn" onclick="seleccionarTemaAcademico('acuerdos')">Incumplimiento de Acuerdos</button>
                    </div>
                </div>
            </div>
            <div id="modalPreguntasAcademico" style="display:none;">
                <p id="modalPreguntaAcademico"></p>
                <div class="modal-buttons" id="modalBotonesAcademico"></div>
                <button class="btn" style="margin-top:2rem;" onclick="volverTemasAcademico()">‚Üê Volver a Temas</button>
            </div>
            <div class="final-accion" id="finalAccionAcademico" style="display:none;">
                <p id="mensajeFinalAcademico"></p>
                <button class="btn download" onclick="descargarFormatoAcademico()">‚¨áÔ∏è Descargar Guia</button>
                <button class="btn" style="margin-top:1.2rem;" onclick="volverTemasAcademico()">Consultar otro caso</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Sistema desarrollado para facilitar la gesti√≥n administrativa de instructores SENA</p>
        <p>Versi√≥n 1.0 - Para uso interno institucional</p>
    </footer>

    <div class="chatbot-bubble-wrapper">
        <button id="chatbot-toggle-button" class="chatbot-toggle-button">
            <i class="fas fa-comment-dots"></i>
        </button>

        <div id="chatbot-popup" class="chatbot-popup-hidden">
            <div class="chat-area-standalone">
                <div class="chat-header">
                    <img src="https://www.sena.edu.co/Style%20Library/alayout/images/logoSena.png?rev=40" alt="Logo SENA - Bot Avatar" class="avatar">
                    <div class="chat-title">
                        <h1>Chatbot Reglamento del Aprendiz SENA</h1>
                        <span>En l√≠nea</span>
                    </div>
                    <div class="chat-header-icons">
                        <i class="fas fa-search"></i>
                        <i class="fas fa-ellipsis-v"></i>
                        <i id="close-chatbot-button" class="fas fa-times"></i>
                    </div>
                </div>
                <div id="chat-box" class="chat-messages"></div>
                <form id="chat-form" class="chat-input-area">
                    <input type="text" id="user-input" placeholder="Escribe tu pregunta..." required>
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>

<script type="module">
    // ====== DATOS Y VARIABLES GLOBALES PARA MODALES ======
    // Estas variables deben ser globales para que las funciones de los modales
    // puedan mantener el estado entre las llamadas a los botones.
    let currentTemaDisciplinarioModal = null;
    let currentStepDisciplinarioModal = null;
    let currentTemaAcademicoModal = null;
    let currentStepAcademicoModal = null;
    let currentModalState = null; // <-- AGREGA ESTA L√çNEA

    // Datos para el flujo disciplinario
    const temasDisciplinarios = {
        'inasistencias': {
            pregunta: '¬øEl aprendiz tiene justificaci√≥n para sus inasistencias?',
            opciones: {
                'Si': {
                    siguiente: 'Ha presentado justificaci√≥n v√°lida. Documenta la justificaci√≥n y arch√≠vala.'
                },
                'No': {
                    pregunta: '¬øEs la primera vez que el aprendiz incurre en inasistencias injustificadas?',
                    opciones: {
                        'Si': {
                            siguiente: 'Debes aplicar un llamado de atenci√≥n verbal disciplinario y registrarlo en el formato correspondiente. Considera un plan de mejoramiento disciplinario si la situaci√≥n persiste.'
                        },
                        'No': {
                            siguiente: 'El aprendiz reincide. Debes implementar un plan de mejoramiento disciplinario. Si no cumple, remite al Comit√© de Evaluaci√≥n y Seguimiento.'
                        }
                    }
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'fraude_plagio': {
            pregunta: '¬øLa evidencia de fraude o plagio es clara y contundente?',
            opciones: {
                'Si': {
                    siguiente: 'Debes aplicar un llamado de atenci√≥n escrito disciplinario. Remite el caso al Comit√© de Evaluaci√≥n y Seguimiento para la aplicaci√≥n de un plan de mejoramiento disciplinario o una sanci√≥n seg√∫n la gravedad.'
                },
                'No': {
                    siguiente: 'Si no hay evidencia clara, busca m√°s pruebas. Si no se puede confirmar, se debe orientar al aprendiz sobre la originalidad y √©tica acad√©mica.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'convivencia': {
            pregunta: '¬øLa falta de convivencia es leve o grave?',
            opciones: {
                'Leve': {
                    siguiente: 'Realiza un llamado de atenci√≥n verbal y un plan de mejoramiento disciplinario de convivencia. Registra la situaci√≥n.'
                },
                'Grave': {
                    siguiente: 'Debes realizar un llamado de atenci√≥n escrito y remitir inmediatamente al Comit√© de Evaluaci√≥n y Seguimiento para acciones m√°s severas.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'recursos': {
            pregunta: '¬øEl uso indebido de recursos ha causado da√±o o perjuicio significativo?',
            opciones: {
                'Si': {
                    siguiente: 'Remite al Comit√© de Evaluaci√≥n y Seguimiento. Puede implicar sanciones graves y la obligaci√≥n de reparaci√≥n del da√±o.'
                },
                'No': {
                    siguiente: 'Realiza un llamado de atenci√≥n verbal y sensibiliza al aprendiz sobre el uso adecuado de los recursos institucionales.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'seguridad': {
            pregunta: '¬øLa violaci√≥n de las normas de seguridad puso en riesgo la integridad f√≠sica de alguna persona o infraestructura?',
            opciones: {
                'Si': {
                    siguiente: 'Remite al Comit√© de Evaluaci√≥n y Seguimiento de forma inmediata. Se requiere una acci√≥n disciplinaria severa.'
                },
                'No': {
                    siguiente: 'Realiza un llamado de atenci√≥n escrito y refuerza la importancia de las normas de seguridad. Monitorea el cumplimiento.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'imagen': {
            pregunta: '¬øLa falta contra la imagen institucional fue p√∫blica y afect√≥ gravemente la reputaci√≥n del SENA?',
            opciones: {
                'Si': {
                    siguiente: 'Remite el caso al Comit√© de Evaluaci√≥n y Seguimiento. Esto puede acarrear sanciones muy graves.'
                },
                'No': {
                    siguiente: 'Realiza un llamado de atenci√≥n escrito y un plan de concientizaci√≥n sobre el respeto a la imagen institucional.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'generales': {
            pregunta: '¬øEl incumplimiento de los deberes generales afecta el desarrollo normal del ambiente de formaci√≥n?',
            opciones: {
                'Si': {
                    siguiente: 'Eval√∫a la gravedad. Si es repetitivo o significativo, remite al Comit√© de Evaluaci√≥n y Seguimiento. Si es aislado, aplica un llamado de atenci√≥n escrito y un plan de mejora.'
                },
                'No': {
                    siguiente: 'Realiza un llamado de atenci√≥n verbal y orienta al aprendiz sobre sus deberes.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'comite_evaluacion': {
            pregunta: '¬øEl caso debe ser remitido al Comit√© de Evaluaci√≥n y Seguimiento?',
            opciones: {
                'Si': {
                    siguiente: 'Prepara el informe detallado del caso y los soportes necesarios para la remisi√≥n al Comit√©. Aseg√∫rate de seguir el debido proceso.'
                },
                'No': {
                    siguiente: 'Contin√∫a aplicando las medidas formativas o disciplinarias de menor nivel seg√∫n lo establecido en el reglamento. Monitorea la evoluci√≥n del aprendiz.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        },
        'medidas_coercitivas': {
            pregunta: '¬øSe requiere aplicar una medida coercitiva o correctiva inmediata debido a la gravedad de la falta?',
            opciones: {
                'Si': {
                    siguiente: 'Aplica la medida coercitiva o correctiva seg√∫n el protocolo y remite el caso de inmediato al Comit√© de Evaluaci√≥n y Seguimiento para su an√°lisis y decisi√≥n definitiva.'
                },
                'No': {
                    siguiente: 'Eval√∫a si la falta puede ser abordada con un llamado de atenci√≥n (verbal o escrito) o un plan de mejoramiento disciplinario. Procede seg√∫n el nivel de la falta.'
                }
            },
            formato: '/static/docs/PROTOCOLO DISCIPLINARIO SENA 2025 rev..docx'
        }
    };

    // Datos para el flujo acad√©mico
    const temasAcademicos = {
        'resultados': {
            pregunta: '¬øSe ha realizado una retroalimentaci√≥n detallada al aprendiz sobre los resultados no logrados?',
            opciones: {
                'Si': {
                    pregunta: '¬øEl aprendiz ha mostrado compromiso para mejorar despu√©s de la retroalimentaci√≥n?',
                    opciones: {
                        'Si': {
                            siguiente: 'Contin√∫a con el seguimiento. Si es necesario, ofrece apoyos adicionales.'
                        },
                        'No': {
                            siguiente: 'Debes aplicar un Llamado de Atenci√≥n Acad√©mico por escrito. Si persiste, plantea un Plan de Mejoramiento Acad√©mico.'
                        }
                    }
                },
                'No': {
                    siguiente: 'Realiza una retroalimentaci√≥n detallada al aprendiz, identificando los resultados de aprendizaje espec√≠ficos que no ha logrado y las √°reas de mejora.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'evidencias': {
            pregunta: '¬øEl aprendiz ha presentado alguna justificaci√≥n v√°lida para la no entrega de evidencias?',
            opciones: {
                'Si': {
                    siguiente: 'Analiza la validez de la justificaci√≥n. Si es aceptada, otorga un nuevo plazo. Si no, aplica un Llamado de Atenci√≥n Acad√©mico.'
                },
                'No': {
                    siguiente: 'Aplica un Llamado de Atenci√≥n Acad√©mico por escrito. Si la situaci√≥n persiste o es recurrente, considera un Plan de Mejoramiento Acad√©mico.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'participacion': {
            pregunta: '¬øLa baja participaci√≥n afecta significativamente el proceso formativo del grupo o el propio aprendizaje del aprendiz?',
            opciones: {
                'Si': {
                    siguiente: 'Realiza un Llamado de Atenci√≥n Acad√©mico y establece acuerdos de participaci√≥n espec√≠ficos. Si no hay mejora, considera un Plan de Mejoramiento Acad√©mico.'
                },
                'No': {
                    siguiente: 'Habla con el aprendiz para entender las causas de la baja participaci√≥n y ofr√©cele estrategias de motivaci√≥n y apoyo.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'mejoramiento': {
            pregunta: '¬øEl incumplimiento de un Plan de Mejoramiento Acad√©mico previamente establecido?',
            opciones: {
                'Si': {
                    siguiente: 'Remite el caso al Comit√© de Evaluaci√≥n y Seguimiento. El Comit√© analizar√° la situaci√≥n y determinar√° las medidas disciplinarias o formativas adicionales.'
                },
                'No': {
                    siguiente: 'Si el plan est√° en curso, realiza seguimiento y ofrece apoyo. Si a√∫n no se ha establecido, identifica la necesidad y cr√©alo.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'prerrequisitos': {
            pregunta: '¬øEl aprendiz cumple con los prerrequisitos necesarios para avanzar en la ruta de aprendizaje actual?',
            opciones: {
                'Si': {
                    siguiente: 'Revisa si hay otras causas para el retraso. Si no, continua con el proceso normal.'
                },
                'No': {
                    siguiente: 'Orienta al aprendiz sobre la importancia de cumplir los prerrequisitos. Si es necesario, suspende temporalmente el avance hasta que los cumpla o remite a coordinaci√≥n para reubicaci√≥n.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'tecnologia': {
            pregunta: '¬øEl uso indebido de recursos tecnol√≥gicos ha afectado el desarrollo de las actividades formativas o la seguridad de la informaci√≥n?',
            opciones: {
                'Si': {
                    siguiente: 'Remite al Comit√© de Evaluaci√≥n y Seguimiento para acciones disciplinarias. Documenta el incidente.'
                },
                'No': {
                    siguiente: 'Realiza un Llamado de Atenci√≥n Acad√©mico y refuerza las normas de uso de recursos tecnol√≥gicos. Sensibiliza sobre la seguridad y el buen uso.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'acuerdos': {
            pregunta: '¬øEl incumplimiento del acuerdo acad√©mico es recurrente o afecta el desempe√±o del grupo?',
            opciones: {
                'Si': {
                    siguiente: 'Aplica un Llamado de Atenci√≥n Acad√©mico por escrito y revisa el acuerdo. Si persiste, considera un Plan de Mejoramiento Acad√©mico.'
                },
                'No': {
                    siguiente: 'Dialoga con el aprendiz para entender la causa del incumplimiento y refuerza el compromiso con el acuerdo.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'plan_mejoramiento_exitoso': {
            pregunta: '¬øEl aprendiz ha logrado superar los resultados de aprendizaje no alcanzados despu√©s de la implementaci√≥n de un Plan de Mejoramiento Acad√©mico?',
            opciones: {
                'Si': {
                    siguiente: 'Registra el cumplimiento satisfactorio del Plan de Mejoramiento Acad√©mico y cierra el caso. Contin√∫a con el seguimiento regular del aprendiz.'
                },
                'No': {
                    siguiente: 'Si el aprendiz no ha logrado superar los resultados de aprendizaje a pesar del Plan de Mejoramiento Acad√©mico, remite el caso al Comit√© de Evaluaci√≥n y Seguimiento para analizar posibles acciones adicionales, incluyendo la cancelaci√≥n de la matr√≠cula.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        },
        'evaluacion_desempeno': {
            pregunta: '¬øLa situaci√≥n actual del aprendiz impacta negativamente su evaluaci√≥n de desempe√±o en la etapa productiva?',
            opciones: {
                'Si': {
                    siguiente: 'Documenta la situaci√≥n y su impacto en la evaluaci√≥n de desempe√±o. Realiza una reuni√≥n con el aprendiz y la empresa, si aplica, para establecer un plan de mejora en la etapa productiva.'
                },
                'No': {
                    siguiente: 'Aseg√∫rate de que la situaci√≥n no escale a un problema que afecte la evaluaci√≥n de desempe√±o. Ofrece acompa√±amiento y recursos de apoyo para mantener el buen rendimiento.'
                }
            },
            formato: '/static/docs/MEDIDAS FORMATIVAS ACADEMICAS.docx'
        }
    };


    // ====== FUNCIONES GLOBALES PARA MODALES (Accesibles por onclick) ======

    // Funciones para el Modal Disciplinario
    window.abrirModalDisciplinario = function() {
        currentModalState = 'disciplinario';
        const modalDisciplinario = document.getElementById('modalDisciplinario');
        const modalTemas = document.getElementById('modalTemas');
        const modalPreguntas = document.getElementById('modalPreguntas');
        const finalAccionDisciplinario = document.getElementById('finalAccionDisciplinario');

        if (modalDisciplinario) modalDisciplinario.style.display = 'flex';
        if (modalTemas) modalTemas.style.display = 'block';
        if (modalPreguntas) modalPreguntas.style.display = 'none';
        if (finalAccionDisciplinario) finalAccionDisciplinario.style.display = 'none';
    };

    window.cerrarModalDisciplinario = function() {
        const modalDisciplinario = document.getElementById('modalDisciplinario');
        const modalTemas = document.getElementById('modalTemas');
        const modalPreguntas = document.getElementById('modalPreguntas');
        const finalAccionDisciplinario = document.getElementById('finalAccionDisciplinario');

        if (modalDisciplinario) modalDisciplinario.style.display = 'none';
        currentTemaDisciplinarioModal = null;
        currentStepDisciplinarioModal = null;
        currentModalState = null;
        if (modalTemas) modalTemas.style.display = 'block'; // Reset to themes view
        if (modalPreguntas) modalPreguntas.style.display = 'none';
        if (finalAccionDisciplinario) finalAccionDisciplinario.style.display = 'none';
    };

    window.seleccionarTema = function(temaKey) {
        currentTemaDisciplinarioModal = temaKey;
        currentStepDisciplinarioModal = temasDisciplinarios[temaKey];
        mostrarPreguntaDisciplinario();
    };

    function mostrarPreguntaDisciplinario() {
        const modalTemas = document.getElementById('modalTemas');
        const modalPreguntas = document.getElementById('modalPreguntas');
        const modalPregunta = document.getElementById('modalPregunta');
        const botonesDiv = document.getElementById('modalBotones');

        if (modalTemas) modalTemas.style.display = 'none';
        if (modalPreguntas) modalPreguntas.style.display = 'block';
        if (modalPregunta && currentStepDisciplinarioModal) modalPregunta.innerText = currentStepDisciplinarioModal.pregunta;

        if (botonesDiv) {
            botonesDiv.innerHTML = '';
            if (currentStepDisciplinarioModal && currentStepDisciplinarioModal.opciones) {
                for (const opcion in currentStepDisciplinarioModal.opciones) {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerText = opcion;
                    button.onclick = () => window.responderPreguntaDisciplinario(opcion);
                    botonesDiv.appendChild(button);
                }
            }
        }
    }

    window.responderPreguntaDisciplinario = function(respuesta) {
        if (!currentStepDisciplinarioModal || !currentStepDisciplinarioModal.opciones || !currentStepDisciplinarioModal.opciones[respuesta]) {
            console.error("Error: Paso o respuesta disciplinaria no v√°lida.");
            return;
        }

        const nextPath = currentStepDisciplinarioModal.opciones[respuesta];
        const modalPreguntas = document.getElementById('modalPreguntas');
        const finalAccionDisciplinario = document.getElementById('finalAccionDisciplinario');
        const mensajeFinalDisciplinario = document.getElementById('mensajeFinalDisciplinario');

        if (nextPath.pregunta) {
            currentStepDisciplinarioModal = nextPath;
            mostrarPreguntaDisciplinario();
        } else {
            if (modalPreguntas) modalPreguntas.style.display = 'none';
            if (finalAccionDisciplinario) finalAccionDisciplinario.style.display = 'block';
            if (mensajeFinalDisciplinario) {
                mensajeFinalDisciplinario.innerHTML = nextPath.siguiente;
            }
        }
    };

    window.volverTemas = function() {
        const modalPreguntas = document.getElementById('modalPreguntas');
        const finalAccionDisciplinario = document.getElementById('finalAccionDisciplinario');
        const modalTemas = document.getElementById('modalTemas');

        if (modalPreguntas) modalPreguntas.style.display = 'none';
        if (finalAccionDisciplinario) finalAccionDisciplinario.style.display = 'none';
        if (modalTemas) modalTemas.style.display = 'block';
        currentTemaDisciplinarioModal = null;
        currentStepDisciplinarioModal = null;
    };

    window.descargarFormatoDisciplinario = function() {
        if (currentTemaDisciplinarioModal && temasDisciplinarios[currentTemaDisciplinarioModal] && temasDisciplinarios[currentTemaDisciplinarioModal].formato) {
            window.open(temasDisciplinarios[currentTemaDisciplinarioModal].formato, '_blank');
        } else {
            alert('No hay un formato espec√≠fico asociado a este tema o paso.');
        }
    };

    // Funciones para el Modal Acad√©mico
    window.abrirModalAcademico = function() {
        currentModalState = 'academico';
        const modalAcademico = document.getElementById('modalAcademico');
        const modalTemasAcademico = document.getElementById('modalTemasAcademico');
        const modalPreguntasAcademico = document.getElementById('modalPreguntasAcademico');
        const finalAccionAcademico = document.getElementById('finalAccionAcademico');

        if (modalAcademico) modalAcademico.style.display = 'flex';
        if (modalTemasAcademico) modalTemasAcademico.style.display = 'block';
        if (modalPreguntasAcademico) modalPreguntasAcademico.style.display = 'none';
        if (finalAccionAcademico) finalAccionAcademico.style.display = 'none';
    };

    window.cerrarModalAcademico = function() {
        const modalAcademico = document.getElementById('modalAcademico');
        const modalTemasAcademico = document.getElementById('modalTemasAcademico');
        const modalPreguntasAcademico = document.getElementById('modalPreguntasAcademico');
        const finalAccionAcademico = document.getElementById('finalAccionAcademico');

        if (modalAcademico) modalAcademico.style.display = 'none';
        currentTemaAcademicoModal = null;
        currentStepAcademicoModal = null;
        currentModalState = null;
        if (modalTemasAcademico) modalTemasAcademico.style.display = 'block';
        if (modalPreguntasAcademico) modalPreguntasAcademico.style.display = 'none';
        if (finalAccionAcademico) finalAccionAcademico.style.display = 'none';
    };

    window.seleccionarTemaAcademico = function(temaKey) {
        currentTemaAcademicoModal = temaKey;
        currentStepAcademicoModal = temasAcademicos[temaKey];
        mostrarPreguntaAcademico();
    };

    function mostrarPreguntaAcademico() {
        const modalTemasAcademico = document.getElementById('modalTemasAcademico');
        const modalPreguntasAcademico = document.getElementById('modalPreguntasAcademico');
        const modalPreguntaAcademico = document.getElementById('modalPreguntaAcademico');
        const botonesDiv = document.getElementById('modalBotonesAcademico');

        if (modalTemasAcademico) modalTemasAcademico.style.display = 'none';
        if (modalPreguntasAcademico) modalPreguntasAcademico.style.display = 'block';
        if (modalPreguntaAcademico && currentStepAcademicoModal) modalPreguntaAcademico.innerText = currentStepAcademicoModal.pregunta;

        if (botonesDiv) {
            botonesDiv.innerHTML = '';
            if (currentStepAcademicoModal && currentStepAcademicoModal.opciones) {
                for (const opcion in currentStepAcademicoModal.opciones) {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.innerText = opcion;
                    button.onclick = () => window.responderPreguntaAcademico(opcion); // Aseg√∫rate de llamar globalmente
                    botonesDiv.appendChild(button);
                }
            }
        }
    }

    window.responderPreguntaAcademico = function(respuesta) {
        if (!currentStepAcademicoModal || !currentStepAcademicoModal.opciones || !currentStepAcademicoModal.opciones[respuesta]) {
            console.error("Error: Paso o respuesta acad√©mica no v√°lida.");
            return;
        }

        const nextPath = currentStepAcademicoModal.opciones[respuesta];
        const modalPreguntasAcademico = document.getElementById('modalPreguntasAcademico');
        const finalAccionAcademico = document.getElementById('finalAccionAcademico');
        const mensajeFinalAcademico = document.getElementById('mensajeFinalAcademico');

        if (nextPath.pregunta) {
            currentStepAcademicoModal = nextPath;
            mostrarPreguntaAcademico();
        } else {
            if (modalPreguntasAcademico) modalPreguntasAcademico.style.display = 'none';
            if (finalAccionAcademico) finalAccionAcademico.style.display = 'block';

            if (mensajeFinalAcademico) {
                mensajeFinalAcademico.innerHTML = nextPath.siguiente;
            }
        }
    };

    window.volverTemasAcademico = function() {
        const modalPreguntasAcademico = document.getElementById('modalPreguntasAcademico');
        const finalAccionAcademico = document.getElementById('finalAccionAcademico');
        const modalTemasAcademico = document.getElementById('modalTemasAcademico');

        if (modalPreguntasAcademico) modalPreguntasAcademico.style.display = 'none';
        if (finalAccionAcademico) finalAccionAcademico.style.display = 'none';
        if (modalTemasAcademico) modalTemasAcademico.style.display = 'block';
        currentTemaAcademicoModal = null;
        currentStepAcademicoModal = null;
    };

    window.descargarFormatoAcademico = function() {
        if (currentTemaAcademicoModal && temasAcademicos[currentTemaAcademicoModal] && temasAcademicos[currentTemaAcademicoModal].formato) {
            window.open(temasAcademicos[currentTemaAcademicoModal].formato, '_blank');
        } else {
            alert('No hay un formato espec√≠fico asociado a este tema o paso.');
        }
    };

    // ====== Inicializaci√≥n de Event Listeners del Chatbot y Click fuera de modales ======
    document.addEventListener('DOMContentLoaded', () => {
        const toggleButton = document.getElementById('chatbot-toggle-button');
        const chatbotPopup = document.getElementById('chatbot-popup');
        const closeButton = document.getElementById('close-chatbot-button');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');

        if (toggleButton) {
            toggleButton.addEventListener('click', () => {
                if (chatbotPopup) {
                    chatbotPopup.classList.remove('chatbot-popup-hidden');
                    chatbotPopup.classList.add('chatbot-popup-visible');
                }
            });
        }

        if (closeButton) {
            closeButton.addEventListener('click', () => {
                if (chatbotPopup) {
                    chatbotPopup.classList.remove('chatbot-popup-visible');
                    chatbotPopup.classList.add('chatbot-popup-hidden');
                }
            });
        }

        if (chatForm) {
            chatForm.onsubmit = async (e) => {
                e.preventDefault();
                const pregunta = chatInput.value;
                if (pregunta.trim() === '') return;

                if (chatBox) {
                    chatBox.innerHTML += `<div class='message user-msg'><div class="message-content">${pregunta}</div><div class="message-time">${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</div></div>`;
                    chatInput.value = '';
                    chatBox.scrollTop = chatBox.scrollHeight;
                }

                await new Promise(resolve => setTimeout(resolve, 500));

                try {
                    const res = await fetch('/pregunta', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pregunta })
                    });

                    const data = await res.json();
                    console.log("Datos recibidos del servidor:", data);

                    if (chatBox) {
                        chatBox.innerHTML += `<div class='message bot-msg'><div class="message-content">${data.respuesta}</div><div class="message-time">${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</div></div>`;
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                } catch (error) {
                    console.error("Error al comunicarse con el backend:", error);
                    if (chatBox) {
                        chatBox.innerHTML += `<div class='message bot-msg'><div class="message-content">Lo siento, no pude conectar con el servidor. Int√©ntalo de nuevo m√°s tarde.</div><div class="message-time">${new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</div></div>`;
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }
            };
        }

        // Listener para cerrar modales al hacer clic fuera
        document.addEventListener('click', function(event) {
            const modalDisciplinario = document.getElementById('modalDisciplinario');
            if (modalDisciplinario && modalDisciplinario.style.display === 'flex') {
                const modalContent = modalDisciplinario.querySelector('.modal-content');
                if (modalContent && !modalContent.contains(event.target) && event.target !== document.getElementById('openDisciplinarioModalButton')) { // Excluir el bot√≥n que abre
                     window.cerrarModalDisciplinario();
                }
            }

            const modalAcademico = document.getElementById('modalAcademico');
            if (modalAcademico && modalAcademico.style.display === 'flex') {
                const modalContent = modalAcademico.querySelector('.modal-content');
                if (modalContent && !modalContent.contains(event.target) && event.target !== document.getElementById('openAcademicoModalButton')) { // Excluir el bot√≥n que abre
                     window.cerrarModalAcademico();
                }
            }
        });
    });
</script>
</body>
</html>